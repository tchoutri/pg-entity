
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tchoutri.github.io/pg-entity/Tutorial/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Tutorial - pg-entity</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
          
          
          <meta name="theme-color" content="#7e56c2">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="deep-purple" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pg-entity-tutorial" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pg-entity" class="md-header__button md-logo" aria-label="pg-entity" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pg-entity
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pg-entity" class="md-nav__button md-logo" aria-label="pg-entity" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    pg-entity
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Guides/" class="md-nav__link">
        Guides
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Tutorial
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pg-entity-tutorial" class="md-nav__link">
    pg-entity tutorial
  </a>
  
    <nav class="md-nav" aria-label="pg-entity tutorial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-our-data-types" class="md-nav__link">
    Setting up our data-types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-generics" class="md-nav__link">
    Using Generics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-the-sql-migrations" class="md-nav__link">
    Writing the SQL migrations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-queries" class="md-nav__link">
    Making queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pg-entity-tutorial" class="md-nav__link">
    pg-entity tutorial
  </a>
  
    <nav class="md-nav" aria-label="pg-entity tutorial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-our-data-types" class="md-nav__link">
    Setting up our data-types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-generics" class="md-nav__link">
    Using Generics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-the-sql-migrations" class="md-nav__link">
    Writing the SQL migrations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-queries" class="md-nav__link">
    Making queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Tutorial</h1>

<h2 id="pg-entity-tutorial">pg-entity tutorial</h2>
<p>In this tutorial, you will learn how to implement the Entity typeclass for your business logic data-types, and run
queries against the database.</p>
<h3 id="setting-up-our-data-types">Setting up our data-types</h3>
<p>First, let us enable a couple of extension</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Traditional list &amp; string syntax</span><span class="w"></span>
<span class="cm">{-# LANGUAGE OverloadedLists #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE OverloadedStrings #-}</span><span class="w"></span>
<span class="c1">-- Quasi-quoter to construct SQL expressions</span><span class="w"></span>
<span class="cm">{-# LANGUAGE QuasiQuotes #-}</span><span class="w"></span>
<span class="c1">-- Deriving machinery</span><span class="w"></span>
<span class="cm">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE DeriveAnyClass #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE DerivingVia #-}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>
<p><code>OverloadedLists</code> allow us to use the <code>[list]</code> syntax for datatypes other than List, like Vector.</p>
</li>
<li>
<p><code>QuasiQuotes</code> enable us to write plain SQL and field names in a <code>[|quasi-quoter block|]</code>.</p>
</li>
<li>
<p>The Deriving extensions give us more powerful typeclass derivation.</p>
</li>
</ul>
<p>Then, let's import some data-types and modules:</p>
<div class="highlight"><pre><span></span><code><span class="kr">import</span><span class="w"> </span><span class="nn">Data.Time</span><span class="w"> </span><span class="p">(</span><span class="kt">UTCTime</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.UUID</span><span class="w"> </span><span class="p">(</span><span class="kt">UUID</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Database.PostgreSQL.Simple</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Database.PostgreSQL.Transact</span><span class="w"> </span><span class="p">(</span><span class="kt">DBT</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Pool</span><span class="w"></span>

<span class="kr">import</span><span class="w"> </span><span class="nn">Database.PostgreSQL.Entity</span><span class="w"></span>
</code></pre></div>
<p>And let's write down our initial data models for a blog. <code>Author</code>, and <code>BlogPost</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- | It is good practice to wrap your primary key in a newtype to gain more</span><span class="w"></span>
<span class="c1">-- type-safety, but without losing access to typeclass instances of the</span><span class="w"></span>
<span class="c1">-- underlying type, with `deriving newtype`.</span><span class="w"></span>
<span class="kr">newtype</span><span class="w"> </span><span class="kt">AuthorId</span><span class="w"></span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kt">AuthorId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">getAuthorId</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">UUID</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="kr">newtype</span><span class="w"> </span><span class="p">(</span><span class="kt">Eq</span><span class="p">,</span><span class="w"> </span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">FromField</span><span class="p">,</span><span class="w"> </span><span class="kt">ToField</span><span class="p">)</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="kt">Author</span><span class="w"></span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kt">Author</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">-- | Primary key</span><span class="w"></span>
<span class="w">             </span><span class="n">authorId</span><span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="kt">AuthorId</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w">      </span><span class="ow">::</span><span class="w"> </span><span class="kt">Text</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w"> </span><span class="n">createdAt</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">UTCTime</span><span class="w"></span>
<span class="w">           </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="p">(</span><span class="kt">Eq</span><span class="p">,</span><span class="w"> </span><span class="kt">Generic</span><span class="p">,</span><span class="w"> </span><span class="kt">Show</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- ^ Instances that are provided by the Haskell Report are known as `stock` classes.</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="n">anyclass</span><span class="w"> </span><span class="p">(</span><span class="kt">FromRow</span><span class="p">,</span><span class="w"> </span><span class="kt">ToRow</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- ^ Other instances are marked derived using the `anyclass` strategy</span><span class="w"></span>
</code></pre></div>
<p>and</p>
<div class="highlight"><pre><span></span><code><span class="kr">newtype</span><span class="w"> </span><span class="kt">BlogPostId</span><span class="w"></span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kt">BlogPostId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">getBlogPostId</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">UUID</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="kr">newtype</span><span class="w"> </span><span class="p">(</span><span class="kt">Eq</span><span class="p">,</span><span class="w"> </span><span class="kt">FromField</span><span class="p">,</span><span class="w"> </span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">ToField</span><span class="p">)</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="kt">BlogPost</span><span class="w"></span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kt">BlogPost</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">-- | Primary key</span><span class="w"></span>
<span class="w">               </span><span class="n">blogPostId</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">BlogPostId</span><span class="w"></span>
<span class="w">               </span><span class="c1">-- | Foreign key</span><span class="w"></span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="n">authorId</span><span class="w">   </span><span class="ow">::</span><span class="w"> </span><span class="kt">AuthorId</span><span class="w"></span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w">      </span><span class="ow">::</span><span class="w"> </span><span class="kt">Text</span><span class="w"></span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="w">    </span><span class="ow">::</span><span class="w"> </span><span class="kt">Text</span><span class="w"></span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="n">createdAt</span><span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="kt">UTCTime</span><span class="w"></span>
<span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="p">(</span><span class="kt">Eq</span><span class="p">,</span><span class="w"> </span><span class="kt">Generic</span><span class="p">,</span><span class="w"> </span><span class="kt">Show</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="n">anyclass</span><span class="w"> </span><span class="p">(</span><span class="kt">FromRow</span><span class="p">,</span><span class="w"> </span><span class="kt">ToRow</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Let us write the <code>Entity</code> instances now:</p>
<div class="highlight"><pre><span></span><code><span class="kr">instance</span><span class="w"> </span><span class="kt">Entity</span><span class="w"> </span><span class="kt">Author</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">  </span><span class="n">tableName</span><span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;authors&quot;</span><span class="w"></span>
<span class="w">  </span><span class="n">primaryKey</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">author_id</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">fields</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">author_id</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">               </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">               </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">               </span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>The above instance declaration reads as:</p>
<blockquote>
<p>My table's name is <em>authors</em>, its primary key is <em>author_id</em>, and the fields are <em>author_id</em>, <em>name</em>, and <em>created_at</em>.</p>
</blockquote>
<p>The order matters for the declarations, so make sure that each field is at the correct position.</p>
<p>Let's do the same for <code>BlogPost</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kr">instance</span><span class="w"> </span><span class="kt">Entity</span><span class="w"> </span><span class="kt">BlogPost</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">  </span><span class="n">tableName</span><span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;blogposts&quot;</span><span class="w"></span>
<span class="w">  </span><span class="n">primaryKey</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">blogpost_id</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">fields</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">blogpost_id</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">author_id</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">|</span><span class="p">]</span><span class="w"></span>
<span class="w">           </span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>And these instances will give you access to the Entity functions to query your tables</p>
<h3 id="using-generics">Using Generics</h3>
<p>But all these manual instances are a tad tedious. Fortunately, there is a derivation mechanism available that allows you
to automate the generation of the <code>Entity</code> instance. This mechanism is called <code>DerivingVia</code>.
It allows you to use a wrapper, called <code>GenericEntity</code>, and a list of options at the type-level to generate the instance</p>
<div class="highlight"><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="kt">Author</span><span class="w"></span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kt">Author</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">authorId</span><span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="kt">AuthorId</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w">      </span><span class="ow">::</span><span class="w"> </span><span class="kt">Text</span><span class="w"></span>
<span class="w">           </span><span class="p">,</span><span class="w"> </span><span class="n">createdAt</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">UTCTime</span><span class="w"></span>
<span class="w">           </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="p">(</span><span class="kt">Eq</span><span class="p">,</span><span class="w"> </span><span class="kt">Generic</span><span class="p">,</span><span class="w"> </span><span class="kt">Show</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="n">anyclass</span><span class="w"> </span><span class="p">(</span><span class="kt">FromRow</span><span class="p">,</span><span class="w"> </span><span class="kt">ToRow</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Entity</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">via</span><span class="w"> </span><span class="p">(</span><span class="kt">GenericEntity</span><span class="w"> </span><span class="kt">&#39;[ TableName &quot;authors&quot;</span>
<span class="kt">                        , PrimaryKey &quot;author_id&quot;</span>
<span class="kt">                        ]</span><span class="w"> </span><span class="kt">Author</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Those two options, <code>TableName</code> and <code>PrimaryKey</code> are optional, and the library will adopt the following defaults:</p>
<ul>
<li><code>tableName</code> will be the snake_case version of the record's name. No pluralisation will be done.</li>
<li><code>primaryKey</code> will be the snake_case version of the first field of the record.</li>
<li><code>field</code> names will be the snake_case version of the record fields.</li>
</ul>
<p>The advantages brought by this technique are that the error surface is reduced when implementing the <code>Entity</code> typeclass.</p>
<p>⚠ While all these deriving parameters are optional, I advise you to write down the table name (with the <code>TableName</code> option).
In the PostgreSQL world, it is customary to pluralise the name of the table containing your data, and
<code>pg-entity</code> does not automatically do this.</p>
<p>⚠ For performance reasons, you are advised to write the primary key in the options. If you do not, the generic deriving mechanism will have to do a linear
search in the fields list (of complexity 𝛰(n) whereas the lookup will take 𝛰(1) if the primary key is given in your code. Do this especially if you have
long tables.</p>
<p>Do it if you have long tables.</p>
<h3 id="writing-the-sql-migrations">Writing the SQL migrations</h3>
<p>In a separate file, we will translate our Haskell data models into SQL migrations.</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">author_id</span><span class="w"> </span><span class="n">uuid</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">timestamptz</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">blogposts</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">blogpost_id</span><span class="w"> </span><span class="n">uuid</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">author_id</span><span class="w"> </span><span class="n">uuid</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">content</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">timestamptz</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">constraint</span><span class="w"> </span><span class="n">fk_author</span><span class="w"></span>
<span class="w">      </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">author_id</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">references</span><span class="w"> </span><span class="n">authors</span><span class="p">(</span><span class="n">author_id</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<h3 id="making-queries">Making queries</h3>
<p>By implementing the <code>Entity</code> Typeclass, your data-type has access to a variety of functions, combinators and helpers that serve the one true purpose of
this library:</p>
<blockquote>
<p>Provide a safe mechanism to expand the fields of a table while writing a query.</p>
</blockquote>
<p>Let us define our insertion function for the Author model:</p>
<div class="highlight"><pre><span></span><code><span class="nf">insertAuthor</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Author</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">DBT</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">insertAuthor</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">insert</span><span class="w"></span>
</code></pre></div>
<p>The result of this function, which we call a “DBT action”, is then passed to <a href="https://hackage.haskell.org/package/pg-entity-0.0.1.0/docs/Database-PostgreSQL-Entity-DBT.html#v:withPool"><code>withPool</code></a>.</p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<p>You can then build a higher-level API endpoint or route controller like that:</p>
<div class="highlight"><pre><span></span><code><span class="nf">addAuthor</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">MonadBaseControl</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Pool</span><span class="w"> </span><span class="kt">Connection</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">AuthorInfo</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">addAuthor</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">newAuthor</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">mkAuthor</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="c1">-- The implementation of this function is left to you</span><span class="w"></span>
<span class="w">  </span><span class="n">withPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">insertAuthor</span><span class="w"> </span><span class="n">newAuthor</span><span class="w"></span>
</code></pre></div>
<p>And if you want to later select an <code>Author</code> based on its <code>AuthorId</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nf">getAuthor</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">MonadError</span><span class="w"> </span><span class="kt">MyCustomError</span><span class="p">,</span><span class="w"> </span><span class="kt">MonadBaseControl</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Pool</span><span class="w"> </span><span class="kt">Connection</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">AuthorId</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="kt">Author</span><span class="w"></span>
<span class="nf">getAuthor</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="n">authorId</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">withPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">selectOneById</span><span class="w"> </span><span class="p">(</span><span class="kt">Only</span><span class="w"> </span><span class="n">authorId</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>This is the end of this tutorial. There are many more functions to discover that will help you write your queries.
While you shouldn't have to explore the source code to gain understanding of how to use the library, feel free to
navigate it to see how the underlying mechanisms work. :)</p>
<p>Next, you can consult our Guides section to see how to do error handling.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../Guides/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Guides" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Guides
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>